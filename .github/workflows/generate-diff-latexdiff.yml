
name: Generate Diff PDF (latexdiff)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate_diff:
    runs-on: ubuntu-latest
    # We use a full TeX Live image which contains git-latexdiff and all dependencies
    container:
      image: texlive/texlive:latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Critical: 'fetch-depth: 0' fetches the entire git history.
          # Without this, git-latexdiff cannot find the previous commit.
          fetch-depth: 0
          submodules: recursive

      - name: fix permissions
        run: "chown -R $(id -u):$(id -g) ."

      - name: Generate Diff PDF
        run: |
          cd ./manuscript
          git latexdiff \
            --main main.tex \
            --lualatex \
            --no-view \
            -o diff.pdf \
            HEAD^
          mv diff.pdf ../diff.pdf
      - name: Commit and Push Diff
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          git add diff.pdf
          
          if ! git diff --quiet --cached; then
            git commit -m "Chore: Update diff.pdf showing recent changes"
            git push
          else
            echo "No changes in diff.pdf."
          fi
